# complex_test.aim
# Stress test for AIMacro transpiler
# Tests: nested loops, recursion, arrays, string ops, complex expressions

def factorial(n):
    if n <= 1:
        return 1
    end
    return n * factorial(n - 1)
end

def fibonacci(n):
    if n <= 0:
        return 0
    end
    if n == 1:
        return 1
    end
    a = 0
    b = 1
    i = 2
    while i <= n:
        temp = a + b
        a = b
        b = temp
        i += 1
    end
    return b
end

def is_prime(n):
    if n < 2:
        return 0
    end
    if n == 2:
        return 1
    end
    if n % 2 == 0:
        return 0
    end
    i = 3
    while i * i <= n:
        if n % i == 0:
            return 0
        end
        i += 2
    end
    return 1
end

def bubble_sort(arr, size):
    i = 0
    while i < size - 1:
        j = 0
        while j < size - i - 1:
            if arr[j] > arr[j + 1]:
                temp = arr[j]
                arr[j] = arr[j + 1]
                arr[j + 1] = temp
            end
            j += 1
        end
        i += 1
    end
end

def binary_search(arr, size, target):
    low = 0
    high = size - 1
    while low <= high:
        mid = (low + high) / 2
        if arr[mid] == target:
            return mid
        end
        if arr[mid] < target:
            low = mid + 1
        else:
            high = mid - 1
        end
    end
    return -1
end

def gcd(a, b):
    while b != 0:
        temp = b
        b = a % b
        a = temp
    end
    return a
end

def power(base, exp):
    if exp == 0:
        return 1
    end
    if exp % 2 == 0:
        half = power(base, exp / 2)
        return half * half
    end
    return base * power(base, exp - 1)
end

def sum_array(arr, size):
    total = 0
    i = 0
    while i < size:
        total += arr[i]
        i += 1
    end
    return total
end

def find_max(arr, size):
    if size == 0:
        return 0
    end
    max_val = arr[0]
    i = 1
    while i < size:
        if arr[i] > max_val:
            max_val = arr[i]
        end
        i += 1
    end
    return max_val
end

def count_divisors(n):
    count = 0
    i = 1
    while i * i <= n:
        if n % i == 0:
            count += 1
            if i != n / i:
                count += 1
            end
        end
        i += 1
    end
    return count
end

def main():
    print("=== AIMacro Complex Test ===")
    
    # Test factorial
    print("Factorial 5:")
    print(factorial(5))
    
    # Test fibonacci
    print("Fibonacci 10:")
    print(fibonacci(10))
    
    # Test prime checker
    print("Primes up to 20:")
    n = 2
    while n <= 20:
        if is_prime(n) == 1:
            print(n)
        end
        n += 1
    end
    
    # Test GCD
    print("GCD of 48 and 18:")
    print(gcd(48, 18))
    
    # Test power
    print("2^10:")
    print(power(2, 10))
    
    # Test divisor count
    print("Divisors of 36:")
    print(count_divisors(36))
    
    # Test array operations
    print("Array test:")
    arr = [64, 34, 25, 12, 22, 11, 90]
    print("Before sort - max:")
    print(find_max(arr, 7))
    print("Sum:")
    print(sum_array(arr, 7))
    
    bubble_sort(arr, 7)
    print("After sort - first element:")
    print(arr[0])
    print("Last element:")
    print(arr[6])
    
    # Binary search
    pos = binary_search(arr, 7, 25)
    print("Position of 25:")
    print(pos)
    
    print("=== Tests Complete ===")
end