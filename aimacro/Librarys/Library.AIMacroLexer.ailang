// Library.AIMacroLexer.ailang
// Lexical analyzer for AIMacro - Python-like syntax with explicit end blocks
// Tokenizes .aim source files for the AIMacro compiler
//
// Usage: LibraryImport.AIMacroLexer

LibraryImport.XArrays

// =============================================================================
// TOKEN TYPES - Integer constants for token identification
// =============================================================================
FixedPool.TokType {
   
    "NUMBER": Initialize=1
    "STRING": Initialize=2
    "IDENTIFIER": Initialize=3
    
  
    "DEF": Initialize=10
    "END": Initialize=11
    "IF": Initialize=12
    "ELIF": Initialize=13
    "ELSE": Initialize=14
    "WHILE": Initialize=15
    "FOR": Initialize=16
    "IN": Initialize=17
    "RETURN": Initialize=18
    "PASS": Initialize=19
    "BREAK": Initialize=20
    "CONTINUE": Initialize=21
    
  
    "TRUE": Initialize=30
    "FALSE": Initialize=31
    "NONE": Initialize=32
    
   
    "AND": Initialize=40
    "OR": Initialize=41
    "NOT": Initialize=42
    "IS": Initialize=43
    
   
    "PLUS": Initialize=50
    "MINUS": Initialize=51
    "MULTIPLY": Initialize=52
    "DIVIDE": Initialize=53
    "FLOOR_DIV": Initialize=54
    "MODULO": Initialize=55
    "POWER": Initialize=56
    
    
    "ASSIGN": Initialize=60
    "PLUS_ASSIGN": Initialize=61
    "MINUS_ASSIGN": Initialize=62
    "MUL_ASSIGN": Initialize=63
    "DIV_ASSIGN": Initialize=64
    
   
    "EQUAL": Initialize=70
    "NOT_EQUAL": Initialize=71
    "LESS": Initialize=72
    "LESS_EQ": Initialize=73
    "GREATER": Initialize=74
    "GREATER_EQ": Initialize=75
    
   
    "LPAREN": Initialize=80
    "RPAREN": Initialize=81
    "LBRACKET": Initialize=82
    "RBRACKET": Initialize=83
    "LBRACE": Initialize=84
    "RBRACE": Initialize=85
    "COMMA": Initialize=86
    "COLON": Initialize=87
    "SEMICOLON": Initialize=88
    "DOT": Initialize=89
    "ARROW": Initialize=90
    
   
    "NEWLINE": Initialize=100
    "EOF": Initialize=101
    "COMMENT": Initialize=102
    "ERROR": Initialize=199
}

// =============================================================================
// LEXER STATE
// =============================================================================
FixedPool.Lexer {
    "source_ptr": Initialize=0       // Pointer to source string
    "source_len": Initialize=0       // Length of source
    "pos": Initialize=0              // Current position
    "line": Initialize=1             // Current line number
    "column": Initialize=1           // Current column
    "at_line_start": Initialize=1    // Flag for line start
    
    // Token output arrays (XArrays)
    "tok_types_ptr": Initialize=0    // Token types
    "tok_values_ptr": Initialize=0   // Token values (strings/numbers)
    "tok_lines_ptr": Initialize=0    // Token line numbers
    "tok_cols_ptr": Initialize=0     // Token column numbers
    "tok_count": Initialize=0        // Number of tokens
    
    // Temporary buffer for building strings/identifiers
    "buffer_ptr": Initialize=0
    "buffer_size": Initialize=256
}

// =============================================================================
// LEXER INITIALIZATION
// =============================================================================
Function.Lexer_Init {
    Input: source: Address
    Input: length: Integer
    Body: {
        Lexer.source_ptr = source
        Lexer.source_len = length
        Lexer.pos = 0
        Lexer.line = 1
        Lexer.column = 1
        Lexer.at_line_start = 1
        Lexer.tok_count = 0
        
        // Create token storage arrays
        Lexer.tok_types_ptr = XArray.XCreate(256)
        Lexer.tok_values_ptr = XArray.XCreate(256)
        Lexer.tok_lines_ptr = XArray.XCreate(256)
        Lexer.tok_cols_ptr = XArray.XCreate(256)
        
        // Allocate temp buffer
        Lexer.buffer_ptr = Allocate(Lexer.buffer_size)
    }
}

Function.Lexer_Cleanup {
    Body: {
        // Free token arrays
        IfCondition NotEqual(Lexer.tok_types_ptr, 0) ThenBlock: {
            XArray.XDestroy(Lexer.tok_types_ptr)
        }
        IfCondition NotEqual(Lexer.tok_values_ptr, 0) ThenBlock: {
            // Free all string values stored
            lex_clean_i = 0
            lex_clean_count = XArray.XSize(Lexer.tok_values_ptr)
            WhileLoop LessThan(lex_clean_i, lex_clean_count) {
                lex_clean_val = XArray.XGet(Lexer.tok_values_ptr, lex_clean_i)
                IfCondition NotEqual(lex_clean_val, 0) ThenBlock: {
                    Deallocate(lex_clean_val, 0)
                }
                lex_clean_i = Add(lex_clean_i, 1)
            }
            XArray.XDestroy(Lexer.tok_values_ptr)
        }
        IfCondition NotEqual(Lexer.tok_lines_ptr, 0) ThenBlock: {
            XArray.XDestroy(Lexer.tok_lines_ptr)
        }
        IfCondition NotEqual(Lexer.tok_cols_ptr, 0) ThenBlock: {
            XArray.XDestroy(Lexer.tok_cols_ptr)
        }
        IfCondition NotEqual(Lexer.buffer_ptr, 0) ThenBlock: {
            Deallocate(Lexer.buffer_ptr, Lexer.buffer_size)
        }
    }
}

// =============================================================================
// CHARACTER HELPERS
// =============================================================================
Function.Lexer_CurrentChar {
    Output: Integer
    Body: {
        IfCondition GreaterEqual(Lexer.pos, Lexer.source_len) ThenBlock: {
            ReturnValue(0)
        }
        lcc_ch = GetByte(Lexer.source_ptr, Lexer.pos)
        ReturnValue(lcc_ch)
    }
}

Function.Lexer_PeekChar {
    Input: offset: Integer
    Output: Integer
    Body: {
        lpc_pos = Add(Lexer.pos, offset)
        IfCondition GreaterEqual(lpc_pos, Lexer.source_len) ThenBlock: {
            ReturnValue(0)
        }
        lpc_ch = GetByte(Lexer.source_ptr, lpc_pos)
        ReturnValue(lpc_ch)
    }
}

Function.Lexer_Advance {
    Body: {
        IfCondition LessThan(Lexer.pos, Lexer.source_len) ThenBlock: {
            la_ch = GetByte(Lexer.source_ptr, Lexer.pos)
            IfCondition EqualTo(la_ch, 10) ThenBlock: {
                // Newline
                Lexer.line = Add(Lexer.line, 1)
                Lexer.column = 1
                Lexer.at_line_start = 1
            } ElseBlock: {
                Lexer.column = Add(Lexer.column, 1)
                // Check if non-whitespace
                IfCondition And(NotEqual(la_ch, 32), NotEqual(la_ch, 9)) ThenBlock: {
                    Lexer.at_line_start = 0
                }
            }
            Lexer.pos = Add(Lexer.pos, 1)
        }
    }
}

Function.Lexer_IsDigit {
    Input: ch: Integer
    Output: Integer
    Body: {
        IfCondition And(GreaterEqual(ch, 48), LessEqual(ch, 57)) ThenBlock: {
            ReturnValue(1)
        }
        ReturnValue(0)
    }
}

Function.Lexer_IsAlpha {
    Input: ch: Integer
    Output: Integer
    Body: {
        IfCondition And(GreaterEqual(ch, 65), LessEqual(ch, 90)) ThenBlock: {
            ReturnValue(1)
        }
        IfCondition And(GreaterEqual(ch, 97), LessEqual(ch, 122)) ThenBlock: {
            ReturnValue(1)
        }
        IfCondition EqualTo(ch, 95) ThenBlock: {
            ReturnValue(1)
        }
        ReturnValue(0)
    }
}

Function.Lexer_IsAlnum {
    Input: ch: Integer
    Output: Integer
    Body: {
        lia_alpha = Lexer_IsAlpha(ch)
        IfCondition EqualTo(lia_alpha, 1) ThenBlock: {
            ReturnValue(1)
        }
        lia_digit = Lexer_IsDigit(ch)
        ReturnValue(lia_digit)
    }
}

// =============================================================================
// TOKEN EMISSION
// =============================================================================
Function.Lexer_AddToken {
    Input: tok_type: Integer
    Input: tok_value: Address
    Body: {
        XArray.XAppend(Lexer.tok_types_ptr, tok_type)
        XArray.XAppend(Lexer.tok_values_ptr, tok_value)
        XArray.XAppend(Lexer.tok_lines_ptr, Lexer.line)
        XArray.XAppend(Lexer.tok_cols_ptr, Lexer.column)
        Lexer.tok_count = Add(Lexer.tok_count, 1)
    }
}

Function.Lexer_AddTokenSimple {
    Input: tok_type: Integer
    Body: {
        Lexer_AddToken(tok_type, 0)
    }
}

// =============================================================================
// STRING/NUMBER READING
// =============================================================================
Function.Lexer_ReadString {
    Output: Address
    Body: {
        lrs_quote = Lexer_CurrentChar()
        Lexer_Advance()
        
        lrs_buf_pos = 0
        lrs_done = 0
        
        WhileLoop EqualTo(lrs_done, 0) {
            lrs_ch = Lexer_CurrentChar()
            
            IfCondition EqualTo(lrs_ch, 0) ThenBlock: {
                // Unterminated string
                lrs_done = 1
            } ElseBlock: {
                IfCondition EqualTo(lrs_ch, lrs_quote) ThenBlock: {
                    lrs_done = 1
                } ElseBlock: {
                    // Handle escape sequences
                    IfCondition EqualTo(lrs_ch, 92) ThenBlock: {
                        Lexer_Advance()
                        lrs_esc = Lexer_CurrentChar()
                        IfCondition EqualTo(lrs_esc, 110) ThenBlock: {
                            SetByte(Lexer.buffer_ptr, lrs_buf_pos, 10)
                        } ElseBlock: {
                            IfCondition EqualTo(lrs_esc, 116) ThenBlock: {
                                SetByte(Lexer.buffer_ptr, lrs_buf_pos, 9)
                            } ElseBlock: {
                                IfCondition EqualTo(lrs_esc, 114) ThenBlock: {
                                    SetByte(Lexer.buffer_ptr, lrs_buf_pos, 13)
                                } ElseBlock: {
                                    SetByte(Lexer.buffer_ptr, lrs_buf_pos, lrs_esc)
                                }
                            }
                        }
                        lrs_buf_pos = Add(lrs_buf_pos, 1)
                        Lexer_Advance()
                    } ElseBlock: {
                        SetByte(Lexer.buffer_ptr, lrs_buf_pos, lrs_ch)
                        lrs_buf_pos = Add(lrs_buf_pos, 1)
                        Lexer_Advance()
                    }
                }
            }
        }
        
        // Skip closing quote
        Lexer_Advance()
        
        // Allocate and copy result
        lrs_result_size = Add(lrs_buf_pos, 1)
        lrs_result = Allocate(lrs_result_size)
        lrs_i = 0
        WhileLoop LessThan(lrs_i, lrs_buf_pos) {
            lrs_c = GetByte(Lexer.buffer_ptr, lrs_i)
            SetByte(lrs_result, lrs_i, lrs_c)
            lrs_i = Add(lrs_i, 1)
        }
        SetByte(lrs_result, lrs_buf_pos, 0)
        
        ReturnValue(lrs_result)
    }
}

Function.Lexer_ReadNumber {
    Output: Integer
    Body: {
        lrn_value = 0
        lrn_done = 0
        
        WhileLoop EqualTo(lrn_done, 0) {
            lrn_ch = Lexer_CurrentChar()
            lrn_is_digit = Lexer_IsDigit(lrn_ch)
            IfCondition EqualTo(lrn_is_digit, 1) ThenBlock: {
                lrn_digit = Subtract(lrn_ch, 48)
                lrn_value = Multiply(lrn_value, 10)
                lrn_value = Add(lrn_value, lrn_digit)
                Lexer_Advance()
            } ElseBlock: {
                lrn_done = 1
            }
        }
        
        ReturnValue(lrn_value)
    }
}

Function.Lexer_ReadIdentifier {
    Output: Address
    Body: {
        lri_buf_pos = 0
        lri_done = 0
        
        WhileLoop EqualTo(lri_done, 0) {
            lri_ch = Lexer_CurrentChar()
            lri_is_alnum = Lexer_IsAlnum(lri_ch)
            IfCondition EqualTo(lri_is_alnum, 1) ThenBlock: {
                SetByte(Lexer.buffer_ptr, lri_buf_pos, lri_ch)
                lri_buf_pos = Add(lri_buf_pos, 1)
                Lexer_Advance()
            } ElseBlock: {
                lri_done = 1
            }
        }
        
        // Allocate and copy
        lri_result_size = Add(lri_buf_pos, 1)
        lri_result = Allocate(lri_result_size)
        lri_i = 0
        WhileLoop LessThan(lri_i, lri_buf_pos) {
            lri_c = GetByte(Lexer.buffer_ptr, lri_i)
            SetByte(lri_result, lri_i, lri_c)
            lri_i = Add(lri_i, 1)
        }
        SetByte(lri_result, lri_buf_pos, 0)
        
        ReturnValue(lri_result)
    }
}

// =============================================================================
// KEYWORD MATCHING
// =============================================================================
Function.Lexer_MatchKeyword {
    Input: word: Address
    Output: Integer
    Body: {
        // Check each keyword
        lmk_cmp = StringCompare(word, "def")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.DEF) }
        
        lmk_cmp = StringCompare(word, "end")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.END) }
        
        lmk_cmp = StringCompare(word, "if")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.IF) }
        
        lmk_cmp = StringCompare(word, "elif")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.ELIF) }
        
        lmk_cmp = StringCompare(word, "else")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.ELSE) }
        
        lmk_cmp = StringCompare(word, "while")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.WHILE) }
        
        lmk_cmp = StringCompare(word, "for")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.FOR) }
        
        lmk_cmp = StringCompare(word, "in")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.IN) }
        
        lmk_cmp = StringCompare(word, "return")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.RETURN) }
        
        lmk_cmp = StringCompare(word, "pass")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.PASS) }
        
        lmk_cmp = StringCompare(word, "break")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.BREAK) }
        
        lmk_cmp = StringCompare(word, "continue")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.CONTINUE) }
        
        lmk_cmp = StringCompare(word, "True")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.TRUE) }
        
        lmk_cmp = StringCompare(word, "False")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.FALSE) }
        
        lmk_cmp = StringCompare(word, "None")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.NONE) }
        
        lmk_cmp = StringCompare(word, "and")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.AND) }
        
        lmk_cmp = StringCompare(word, "or")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.OR) }
        
        lmk_cmp = StringCompare(word, "not")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.NOT) }
        
        lmk_cmp = StringCompare(word, "is")
        IfCondition EqualTo(lmk_cmp, 0) ThenBlock: { ReturnValue(TokType.IS) }
        
        // Not a keyword - it's an identifier
        ReturnValue(TokType.IDENTIFIER)
    }
}

// =============================================================================
// MAIN TOKENIZE FUNCTION
// =============================================================================
Function.Lexer_Tokenize {
    Output: Integer
    Body: {
        lt_done = 0
        
        WhileLoop EqualTo(lt_done, 0) {
            lt_ch = Lexer_CurrentChar()
            
            // End of source
            IfCondition EqualTo(lt_ch, 0) ThenBlock: {
                lt_done = 1
            } ElseBlock: {
                // Skip whitespace (not newlines)
                IfCondition Or(EqualTo(lt_ch, 32), EqualTo(lt_ch, 9)) ThenBlock: {
                    Lexer_Advance()
                    
                // Newline
                } ElseBlock: {
                    IfCondition EqualTo(lt_ch, 10) ThenBlock: {
                        Lexer_AddTokenSimple(TokType.NEWLINE)
                        Lexer_Advance()
                        
                    // Comment
                    } ElseBlock: {
                        IfCondition EqualTo(lt_ch, 35) ThenBlock: {
                            // Skip to end of line
                            lt_comment_done = 0
                            WhileLoop EqualTo(lt_comment_done, 0) {
                                lt_cc = Lexer_CurrentChar()
                                IfCondition Or(EqualTo(lt_cc, 0), EqualTo(lt_cc, 10)) ThenBlock: {
                                    lt_comment_done = 1
                                } ElseBlock: {
                                    Lexer_Advance()
                                }
                            }
                            
                        // String literals
                        } ElseBlock: {
                            IfCondition Or(EqualTo(lt_ch, 34), EqualTo(lt_ch, 39)) ThenBlock: {
                                lt_str = Lexer_ReadString()
                                Lexer_AddToken(TokType.STRING, lt_str)
                                
                            // Numbers
                            } ElseBlock: {
                                lt_is_digit = Lexer_IsDigit(lt_ch)
                                IfCondition EqualTo(lt_is_digit, 1) ThenBlock: {
                                    lt_num = Lexer_ReadNumber()
                                    Lexer_AddToken(TokType.NUMBER, lt_num)
                                    
                                // Identifiers and keywords
                                } ElseBlock: {
                                    lt_is_alpha = Lexer_IsAlpha(lt_ch)
                                    IfCondition EqualTo(lt_is_alpha, 1) ThenBlock: {
                                        lt_ident = Lexer_ReadIdentifier()
                                        lt_kw = Lexer_MatchKeyword(lt_ident)
                                        IfCondition EqualTo(lt_kw, TokType.IDENTIFIER) ThenBlock: {
                                            Lexer_AddToken(TokType.IDENTIFIER, lt_ident)
                                        } ElseBlock: {
                                            Lexer_AddTokenSimple(lt_kw)
                                            Deallocate(lt_ident, 0)
                                        }
                                        
                                    // Operators - two char first
                                    } ElseBlock: {
                                        lt_next = Lexer_PeekChar(1)
                                        lt_matched_two = 0
                                        
                                        // ==
                                        IfCondition And(EqualTo(lt_ch, 61), EqualTo(lt_next, 61)) ThenBlock: {
                                            Lexer_AddTokenSimple(TokType.EQUAL)
                                            Lexer_Advance()
                                            Lexer_Advance()
                                            lt_matched_two = 1
                                        }
                                        // !=
                                        IfCondition And(EqualTo(lt_ch, 33), EqualTo(lt_next, 61)) ThenBlock: {
                                            Lexer_AddTokenSimple(TokType.NOT_EQUAL)
                                            Lexer_Advance()
                                            Lexer_Advance()
                                            lt_matched_two = 1
                                        }
                                        // <=
                                        IfCondition And(EqualTo(lt_ch, 60), EqualTo(lt_next, 61)) ThenBlock: {
                                            Lexer_AddTokenSimple(TokType.LESS_EQ)
                                            Lexer_Advance()
                                            Lexer_Advance()
                                            lt_matched_two = 1
                                        }
                                        // >=
                                        IfCondition And(EqualTo(lt_ch, 62), EqualTo(lt_next, 61)) ThenBlock: {
                                            Lexer_AddTokenSimple(TokType.GREATER_EQ)
                                            Lexer_Advance()
                                            Lexer_Advance()
                                            lt_matched_two = 1
                                        }
                                        // **
                                        IfCondition And(EqualTo(lt_ch, 42), EqualTo(lt_next, 42)) ThenBlock: {
                                            Lexer_AddTokenSimple(TokType.POWER)
                                            Lexer_Advance()
                                            Lexer_Advance()
                                            lt_matched_two = 1
                                        }
                                        // //
                                        IfCondition And(EqualTo(lt_ch, 47), EqualTo(lt_next, 47)) ThenBlock: {
                                            Lexer_AddTokenSimple(TokType.FLOOR_DIV)
                                            Lexer_Advance()
                                            Lexer_Advance()
                                            lt_matched_two = 1
                                        }
                                        // +=
                                        IfCondition And(EqualTo(lt_ch, 43), EqualTo(lt_next, 61)) ThenBlock: {
                                            Lexer_AddTokenSimple(TokType.PLUS_ASSIGN)
                                            Lexer_Advance()
                                            Lexer_Advance()
                                            lt_matched_two = 1
                                        }
                                        // -=
                                        IfCondition And(EqualTo(lt_ch, 45), EqualTo(lt_next, 61)) ThenBlock: {
                                            Lexer_AddTokenSimple(TokType.MINUS_ASSIGN)
                                            Lexer_Advance()
                                            Lexer_Advance()
                                            lt_matched_two = 1
                                        }
                                        // *=
                                        IfCondition And(EqualTo(lt_ch, 42), EqualTo(lt_next, 61)) ThenBlock: {
                                            Lexer_AddTokenSimple(TokType.MUL_ASSIGN)
                                            Lexer_Advance()
                                            Lexer_Advance()
                                            lt_matched_two = 1
                                        }
                                        // /=
                                        IfCondition And(EqualTo(lt_ch, 47), EqualTo(lt_next, 61)) ThenBlock: {
                                            Lexer_AddTokenSimple(TokType.DIV_ASSIGN)
                                            Lexer_Advance()
                                            Lexer_Advance()
                                            lt_matched_two = 1
                                        }
                                        // ->
                                        IfCondition And(EqualTo(lt_ch, 45), EqualTo(lt_next, 62)) ThenBlock: {
                                            Lexer_AddTokenSimple(TokType.ARROW)
                                            Lexer_Advance()
                                            Lexer_Advance()
                                            lt_matched_two = 1
                                        }
                                        
                                        // Single char operators
                                        IfCondition EqualTo(lt_matched_two, 0) ThenBlock: {
                                            IfCondition EqualTo(lt_ch, 43) ThenBlock: {
                                                Lexer_AddTokenSimple(TokType.PLUS)
                                                Lexer_Advance()
                                            } ElseBlock: {
                                                IfCondition EqualTo(lt_ch, 45) ThenBlock: {
                                                    Lexer_AddTokenSimple(TokType.MINUS)
                                                    Lexer_Advance()
                                                } ElseBlock: {
                                                    IfCondition EqualTo(lt_ch, 42) ThenBlock: {
                                                        Lexer_AddTokenSimple(TokType.MULTIPLY)
                                                        Lexer_Advance()
                                                    } ElseBlock: {
                                                        IfCondition EqualTo(lt_ch, 47) ThenBlock: {
                                                            Lexer_AddTokenSimple(TokType.DIVIDE)
                                                            Lexer_Advance()
                                                        } ElseBlock: {
                                                            IfCondition EqualTo(lt_ch, 37) ThenBlock: {
                                                                Lexer_AddTokenSimple(TokType.MODULO)
                                                                Lexer_Advance()
                                                            } ElseBlock: {
                                                                IfCondition EqualTo(lt_ch, 61) ThenBlock: {
                                                                    Lexer_AddTokenSimple(TokType.ASSIGN)
                                                                    Lexer_Advance()
                                                                } ElseBlock: {
                                                                    IfCondition EqualTo(lt_ch, 60) ThenBlock: {
                                                                        Lexer_AddTokenSimple(TokType.LESS)
                                                                        Lexer_Advance()
                                                                    } ElseBlock: {
                                                                        IfCondition EqualTo(lt_ch, 62) ThenBlock: {
                                                                            Lexer_AddTokenSimple(TokType.GREATER)
                                                                            Lexer_Advance()
                                                                        } ElseBlock: {
                                                                            IfCondition EqualTo(lt_ch, 40) ThenBlock: {
                                                                                Lexer_AddTokenSimple(TokType.LPAREN)
                                                                                Lexer_Advance()
                                                                            } ElseBlock: {
                                                                                IfCondition EqualTo(lt_ch, 41) ThenBlock: {
                                                                                    Lexer_AddTokenSimple(TokType.RPAREN)
                                                                                    Lexer_Advance()
                                                                                } ElseBlock: {
                                                                                    IfCondition EqualTo(lt_ch, 91) ThenBlock: {
                                                                                        Lexer_AddTokenSimple(TokType.LBRACKET)
                                                                                        Lexer_Advance()
                                                                                    } ElseBlock: {
                                                                                        IfCondition EqualTo(lt_ch, 93) ThenBlock: {
                                                                                            Lexer_AddTokenSimple(TokType.RBRACKET)
                                                                                            Lexer_Advance()
                                                                                        } ElseBlock: {
                                                                                            IfCondition EqualTo(lt_ch, 123) ThenBlock: {
                                                                                                Lexer_AddTokenSimple(TokType.LBRACE)
                                                                                                Lexer_Advance()
                                                                                            } ElseBlock: {
                                                                                                IfCondition EqualTo(lt_ch, 125) ThenBlock: {
                                                                                                    Lexer_AddTokenSimple(TokType.RBRACE)
                                                                                                    Lexer_Advance()
                                                                                                } ElseBlock: {
                                                                                                    IfCondition EqualTo(lt_ch, 44) ThenBlock: {
                                                                                                        Lexer_AddTokenSimple(TokType.COMMA)
                                                                                                        Lexer_Advance()
                                                                                                    } ElseBlock: {
                                                                                                        IfCondition EqualTo(lt_ch, 58) ThenBlock: {
                                                                                                            Lexer_AddTokenSimple(TokType.COLON)
                                                                                                            Lexer_Advance()
                                                                                                        } ElseBlock: {
                                                                                                            IfCondition EqualTo(lt_ch, 59) ThenBlock: {
                                                                                                                Lexer_AddTokenSimple(TokType.SEMICOLON)
                                                                                                                Lexer_Advance()
                                                                                                            } ElseBlock: {
                                                                                                                IfCondition EqualTo(lt_ch, 46) ThenBlock: {
                                                                                                                    Lexer_AddTokenSimple(TokType.DOT)
                                                                                                                    Lexer_Advance()
                                                                                                                } ElseBlock: {
                                                                                                                    // Unknown char - skip
                                                                                                                    Lexer_Advance()
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        
        // Add EOF token
        Lexer_AddTokenSimple(TokType.EOF)
        
        ReturnValue(Lexer.tok_count)
    }
}

// =============================================================================
// TOKEN ACCESS FUNCTIONS
// =============================================================================
Function.Lexer_GetTokenType {
    Input: index: Integer
    Output: Integer
    Body: {
        IfCondition GreaterEqual(index, Lexer.tok_count) ThenBlock: {
            ReturnValue(TokType.EOF)
        }
        lgtt_type = XArray.XGet(Lexer.tok_types_ptr, index)
        ReturnValue(lgtt_type)
    }
}

Function.Lexer_GetTokenValue {
    Input: index: Integer
    Output: Address
    Body: {
        IfCondition GreaterEqual(index, Lexer.tok_count) ThenBlock: {
            ReturnValue(0)
        }
        lgtv_val = XArray.XGet(Lexer.tok_values_ptr, index)
        ReturnValue(lgtv_val)
    }
}

Function.Lexer_GetTokenLine {
    Input: index: Integer
    Output: Integer
    Body: {
        IfCondition GreaterEqual(index, Lexer.tok_count) ThenBlock: {
            ReturnValue(0)
        }
        lgtl_line = XArray.XGet(Lexer.tok_lines_ptr, index)
        ReturnValue(lgtl_line)
    }
}

Function.Lexer_GetTokenColumn {
    Input: index: Integer
    Output: Integer
    Body: {
        IfCondition GreaterEqual(index, Lexer.tok_count) ThenBlock: {
            ReturnValue(0)
        }
        lgtc_col = XArray.XGet(Lexer.tok_cols_ptr, index)
        ReturnValue(lgtc_col)
    }
}

Function.Lexer_GetTokenCount {
    Output: Integer
    Body: {
        ReturnValue(Lexer.tok_count)
    }
}