// aimacro_console.ailang
// TUI Console Application for AIMacro Compiler
// Uses Linux syscalls for file I/O

LibraryImport.XArrays
LibraryImport.AIMacroCore
LibraryImport.AIMacroParserCore
LibraryImport.AIMacroCodeGen1
LibraryImport.AIMacroCodeGen2
LibraryImport.AIMacroCodeGen3
LibraryImport.AIMacroCodeGen4

// =============================================================================
// CONSOLE STATE
// =============================================================================
FixedPool.Console {
    "running": Initialize=1, CanChange=True
    "debug_mode": Initialize=0, CanChange=True
    "show_tokens": Initialize=0, CanChange=True
    "show_ast": Initialize=0, CanChange=True
    "input_buf": Initialize=0, CanChange=True
    "input_size": Initialize=4096
    "line_buf": Initialize=0, CanChange=True
    "line_size": Initialize=1024
    "multiline_buf": Initialize=0, CanChange=True
    "multiline_pos": Initialize=0, CanChange=True
    "last_output": Initialize=0, CanChange=True
    "last_output_len": Initialize=0, CanChange=True
}

// =============================================================================
// FILE I/O USING SYSCALLS
// =============================================================================
Function.File_Open {
    Input: filename: Address
    Input: flags: Integer
    Output: Integer
    Body: {
        fd = SystemCall(2, filename, flags, 420)
        ReturnValue(fd)
    }
}

Function.File_Close {
    Input: fd: Integer
    Output: Integer
    Body: {
        result = SystemCall(3, fd)
        ReturnValue(result)
    }
}

Function.File_Read {
    Input: fd: Integer
    Input: buffer: Address
    Input: count: Integer
    Output: Integer
    Body: {
        bytes_read = SystemCall(0, fd, buffer, count)
        ReturnValue(bytes_read)
    }
}

Function.File_Write {
    Input: fd: Integer
    Input: buffer: Address
    Input: count: Integer
    Output: Integer
    Body: {
        bytes_written = SystemCall(1, fd, buffer, count)
        ReturnValue(bytes_written)
    }
}

Function.File_GetSize {
    Input: fd: Integer
    Output: Integer
    Body: {
        size = SystemCall(8, fd, 0, 2)
        SystemCall(8, fd, 0, 0)
        ReturnValue(size)
    }
}

Function.File_Exists {
    Input: filename: Address
    Output: Integer
    Body: {
        fd = SystemCall(2, filename, 0, 0)
        IfCondition LessThan(fd, 0) ThenBlock: {
            ReturnValue(0)
        }
        SystemCall(3, fd)
        ReturnValue(1)
    }
}

// =============================================================================
// CONSOLE INITIALIZATION
// =============================================================================
Function.Console_Init {
    Body: {
        Console.input_buf = Allocate(Console.input_size)
        Console.line_buf = Allocate(Console.line_size)
        Console.multiline_buf = Allocate(Console.input_size)
        Console.multiline_pos = 0
        Console.running = 1
        Console.debug_mode = 0
        Console.show_tokens = 0
        Console.show_ast = 0
    }
}

Function.Console_Free {
    Body: {
        IfCondition NotEqual(Console.input_buf, 0) ThenBlock: {
            Deallocate(Console.input_buf, Console.input_size)
        }
        IfCondition NotEqual(Console.line_buf, 0) ThenBlock: {
            Deallocate(Console.line_buf, Console.line_size)
        }
        IfCondition NotEqual(Console.multiline_buf, 0) ThenBlock: {
            Deallocate(Console.multiline_buf, Console.input_size)
        }
    }
}

Function.Console_Banner {
    Body: {
        PrintMessage("\n")
        PrintMessage("========================================================\n")
        PrintMessage("    AIMacro Compiler Console - Pure AILang Edition\n")
        PrintMessage("                   Version 1.1.0\n")
        PrintMessage("========================================================\n")
        PrintMessage("  Type 'help' for commands, 'quit' to exit\n")
        PrintMessage("  Use 'load <file>' to compile an .aim file\n")
        PrintMessage("  Use 'transpile <file> <dir>' for multi-file projects\n")
        PrintMessage("========================================================\n")
        PrintMessage("\n")
    }
}

Function.Console_Help {
    Body: {
        PrintMessage("\n")
        PrintMessage("COMMANDS:\n")
        PrintMessage("  load <file>            - Load and compile an .aim file\n")
        PrintMessage("  save <file>            - Save last compiled output to .ailang file\n")
        PrintMessage("  transpile <file> <dir> - Transpile project with imports to dir\n")
        PrintMessage("  help                   - Show this help message\n")
        PrintMessage("  quit / exit            - Exit the console\n")
        PrintMessage("  clear                  - Clear multiline buffer\n")
        PrintMessage("  debug on/off           - Toggle debug mode\n")
        PrintMessage("  tokens on/off          - Show/hide token output\n")
        PrintMessage("  ast on/off             - Show/hide AST output\n")
        PrintMessage("  status                 - Show current settings\n")
        PrintMessage("  example                - Show example AIMacro code\n")
        PrintMessage("\n")
    }
}

Function.Console_Example {
    Body: {
        PrintMessage("\nEXAMPLE AIMACRO CODE:\n")
        PrintMessage("  def factorial(n):\n")
        PrintMessage("      if n <= 1:\n")
        PrintMessage("          return 1\n")
        PrintMessage("      end\n")
        PrintMessage("      return n * factorial(n - 1)\n")
        PrintMessage("  end\n\n")
    }
}

Function.Console_Status {
    Body: {
        PrintMessage("\nCurrent Settings:\n")
        PrintMessage("  Debug mode:  ")
        IfCondition EqualTo(Console.debug_mode, 1) ThenBlock: {
            PrintMessage("ON\n")
        } ElseBlock: {
            PrintMessage("OFF\n")
        }
        PrintMessage("  Show tokens: ")
        IfCondition EqualTo(Console.show_tokens, 1) ThenBlock: {
            PrintMessage("ON\n")
        } ElseBlock: {
            PrintMessage("OFF\n")
        }
        PrintMessage("  Show AST:    ")
        IfCondition EqualTo(Console.show_ast, 1) ThenBlock: {
            PrintMessage("ON\n")
        } ElseBlock: {
            PrintMessage("OFF\n")
        }
        PrintMessage("\n")
    }
}

// =============================================================================
// STRING UTILITIES
// =============================================================================
Function.Console_StrStartsWith {
    Input: str: Address
    Input: prefix: Address
    Output: Integer
    Body: {
        prefix_len = StringLength(prefix)
        str_len = StringLength(str)
        
        IfCondition LessThan(str_len, prefix_len) ThenBlock: {
            ReturnValue(0)
        }
        
        i = 0
        WhileLoop LessThan(i, prefix_len) {
            c1 = GetByte(str, i)
            c2 = GetByte(prefix, i)
            IfCondition NotEqual(c1, c2) ThenBlock: {
                ReturnValue(0)
            }
            i = Add(i, 1)
        }
        
        ReturnValue(1)
    }
}

Function.Console_Trim {
    Input: str: Address
    Output: Address
    Body: {
        len = StringLength(str)
        
        IfCondition EqualTo(len, 0) ThenBlock: {
            result = Allocate(1)
            SetByte(result, 0, 0)
            ReturnValue(result)
        }
        
        start = 0
        WhileLoop LessThan(start, len) {
            c = GetByte(str, start)
            IfCondition And(NotEqual(c, 32), NotEqual(c, 9)) ThenBlock: {
                IfCondition And(NotEqual(c, 10), NotEqual(c, 13)) ThenBlock: {
                    BreakLoop
                }
            }
            start = Add(start, 1)
        }
        
        end_pos = Subtract(len, 1)
        WhileLoop GreaterEqual(end_pos, start) {
            c = GetByte(str, end_pos)
            IfCondition And(NotEqual(c, 32), NotEqual(c, 9)) ThenBlock: {
                IfCondition And(NotEqual(c, 10), NotEqual(c, 13)) ThenBlock: {
                    BreakLoop
                }
            }
            end_pos = Subtract(end_pos, 1)
        }
        
        new_len = Add(Subtract(end_pos, start), 1)
        IfCondition LessEqual(new_len, 0) ThenBlock: {
            result = Allocate(1)
            SetByte(result, 0, 0)
            ReturnValue(result)
        }
        
        result = Allocate(Add(new_len, 1))
        i = 0
        WhileLoop LessThan(i, new_len) {
            c = GetByte(str, Add(start, i))
            SetByte(result, i, c)
            i = Add(i, 1)
        }
        SetByte(result, new_len, 0)
        
        ReturnValue(result)
    }
}

Function.Console_GetArg {
    Input: str: Address
    Input: start_pos: Integer
    Output: Address
    Body: {
        len = StringLength(str)
        arg_len = Subtract(len, start_pos)
        
        IfCondition LessEqual(arg_len, 0) ThenBlock: {
            result = Allocate(1)
            SetByte(result, 0, 0)
            ReturnValue(result)
        }
        
        result = Allocate(Add(arg_len, 1))
        i = 0
        WhileLoop LessThan(i, arg_len) {
            c = GetByte(str, Add(start_pos, i))
            SetByte(result, i, c)
            i = Add(i, 1)
        }
        SetByte(result, arg_len, 0)
        
        trimmed = Console_Trim(result)
        Deallocate(result, 0)
        ReturnValue(trimmed)
    }
}

Function.Console_CopyString {
    Input: src: Address
    Output: Address
    Body: {
        len = StringLength(src)
        dst = Allocate(Add(len, 1))
        i = 0
        WhileLoop LessThan(i, len) {
            c = GetByte(src, i)
            SetByte(dst, i, c)
            i = Add(i, 1)
        }
        SetByte(dst, len, 0)
        ReturnValue(dst)
    }
}

Function.Console_ArrayContains {
    Input: arr: Address
    Input: str: Address
    Output: Integer
    Body: {
        n = XArray.XSize(arr)
        i = 0
        WhileLoop LessThan(i, n) {
            item = XArray.XGet(arr, i)
            cmp = StringCompare(item, str)
            IfCondition EqualTo(cmp, 0) ThenBlock: {
                ReturnValue(1)
            }
            i = Add(i, 1)
        }
        ReturnValue(0)
    }
}

// =============================================================================
// DEBUG OUTPUT
// =============================================================================
Function.Console_ShowTokens {
    Input: count: Integer
    Body: {
        PrintMessage("--- TOKENS ---\n")
        i = 0
        WhileLoop LessThan(i, count) {
            t = Lex_GetType(i)
            v = Lex_GetVal(i)
            
            PrintMessage("[")
            PrintNumber(i)
            PrintMessage("] T=")
            PrintNumber(t)
            
            IfCondition EqualTo(t, Token.IDENTIFIER) ThenBlock: {
                PrintMessage(" ")
                PrintString(v)
            }
            IfCondition EqualTo(t, Token.NUMBER) ThenBlock: {
                PrintMessage(" =")
                PrintNumber(v)
            }
            IfCondition EqualTo(t, Token.STRING) ThenBlock: {
                PrintMessage(" \"")
                PrintString(v)
                PrintMessage("\"")
            }
            
            PrintMessage("\n")
            i = Add(i, 1)
        }
    }
}

Function.Console_ShowAST {
    Input: ast: Address
    Body: {
        PrintMessage("--- AST ---\n")
        
        decls = ArrayGet(ast, 3)
        n = XArray.XSize(decls)
        
        i = 0
        WhileLoop LessThan(i, n) {
            decl = XArray.XGet(decls, i)
            dt = AST_Type(decl)
            
            PrintMessage("Decl ")
            PrintNumber(i)
            PrintMessage(": Type=")
            PrintNumber(dt)
            
            IfCondition EqualTo(dt, Node.FUNCTION) ThenBlock: {
                fname = ArrayGet(decl, 3)
                PrintMessage(" (")
                PrintString(fname)
                PrintMessage(")")
            }
            
            PrintMessage("\n")
            i = Add(i, 1)
        }
    }
}

// =============================================================================
// COMPILATION
// =============================================================================
Function.Console_Compile {
    Input: source: Address
    Body: {
        len = StringLength(source)
        
        IfCondition LessEqual(len, 0) ThenBlock: {
            PrintMessage("Error: Empty source\n")
            ReturnValue(0)
        }
        
        PrintMessage("\n--- COMPILING ---\n")
        
        Lex_Init(source, len)
        tok_count = Lex_Tokenize()
        
        IfCondition LessEqual(tok_count, 0) ThenBlock: {
            PrintMessage("ERROR: Lexer failed\n")
            Lex_Free()
            ReturnValue(0)
        }
        
        PrintMessage("Lexer: ")
        PrintNumber(tok_count)
        PrintMessage(" tokens\n")
        
        IfCondition EqualTo(Console.show_tokens, 1) ThenBlock: {
            Console_ShowTokens(tok_count)
        }
        
        Parse_Init()
        ast = Parse_Program()
        
        IfCondition EqualTo(Parse.err, 1) ThenBlock: {
            PrintMessage("ERROR: Parse failed at line ")
            PrintNumber(Parse.err_line)
            PrintMessage("\n")
            Lex_Free()
            ReturnValue(0)
        }
        
        decls = ArrayGet(ast, 3)
        num_decls = XArray.XSize(decls)
        PrintMessage("Parser: ")
        PrintNumber(num_decls)
        PrintMessage(" declarations\n")
        
        IfCondition EqualTo(Console.show_ast, 1) ThenBlock: {
            Console_ShowAST(ast)
        }
        
        Gen_Init()
        Gen_Program(ast)
        output = Gen_GetOutput()
        
        out_len = StringLength(output)
        PrintMessage("CodeGen: ")
        PrintNumber(out_len)
        PrintMessage(" bytes output\n")
        
        IfCondition NotEqual(Console.last_output, 0) ThenBlock: {
            Deallocate(Console.last_output, Console.last_output_len)
        }
        
        Console.last_output = Allocate(Add(out_len, 1))
        Console.last_output_len = out_len
        i = 0
        WhileLoop LessThan(i, out_len) {
            c = GetByte(output, i)
            SetByte(Console.last_output, i, c)
            i = Add(i, 1)
        }
        SetByte(Console.last_output, out_len, 0)
        
        PrintMessage("\n=== OUTPUT ===\n")
        PrintString(output)
        PrintMessage("=== END ===\n\n")
        
        Deallocate(output, 0)
        Gen_Free()
        Lex_Free()
    }
}

// =============================================================================
// SAVE OUTPUT TO FILE
// =============================================================================
Function.Console_SaveOutput {
    Input: filename: Address
    Body: {
        IfCondition EqualTo(Console.last_output, 0) ThenBlock: {
            PrintMessage("ERROR: No compiled output to save. Use 'load' first.\n")
            ReturnValue(0)
        }
        
        IfCondition EqualTo(Console.last_output_len, 0) ThenBlock: {
            PrintMessage("ERROR: Output is empty.\n")
            ReturnValue(0)
        }
        
        PrintMessage("Saving to: ")
        PrintString(filename)
        PrintMessage("\n")
        
        fd = File_Open(filename, 577)
        IfCondition LessThan(fd, 0) ThenBlock: {
            PrintMessage("ERROR: Could not create file\n")
            ReturnValue(0)
        }
        
        bytes_written = File_Write(fd, Console.last_output, Console.last_output_len)
        File_Close(fd)
        
        IfCondition LessThan(bytes_written, 0) ThenBlock: {
            PrintMessage("ERROR: Write failed\n")
            ReturnValue(0)
        }
        
        PrintMessage("Saved ")
        PrintNumber(bytes_written)
        PrintMessage(" bytes\n")
    }
}

// =============================================================================
// FILE LOADING
// =============================================================================
Function.Console_LoadFile {
    Input: filename: Address
    Body: {
        PrintMessage("\nLoading: ")
        PrintString(filename)
        PrintMessage("\n")
        
        fd = File_Open(filename, 0)
        IfCondition LessThan(fd, 0) ThenBlock: {
            PrintMessage("ERROR: Could not open file\n")
            ReturnValue(0)
        }
        
        file_size = File_GetSize(fd)
        IfCondition LessEqual(file_size, 0) ThenBlock: {
            PrintMessage("ERROR: Empty file or size error\n")
            File_Close(fd)
            ReturnValue(0)
        }
        
        PrintMessage("File size: ")
        PrintNumber(file_size)
        PrintMessage(" bytes\n")
        
        buffer = Allocate(Add(file_size, 1))
        bytes_read = File_Read(fd, buffer, file_size)
        File_Close(fd)
        
        IfCondition LessEqual(bytes_read, 0) ThenBlock: {
            PrintMessage("ERROR: Failed to read file\n")
            Deallocate(buffer, Add(file_size, 1))
            ReturnValue(0)
        }
        
        SetByte(buffer, bytes_read, 0)
        
        PrintMessage("Read ")
        PrintNumber(bytes_read)
        PrintMessage(" bytes\n")
        
        Console_Compile(buffer)
        
        Deallocate(buffer, Add(file_size, 1))
    }
}

Function.Console_ReadFileContents {
    Input: filename: Address
    Output: Address
    Body: {
        fd = File_Open(filename, 0)
        IfCondition LessThan(fd, 0) ThenBlock: {
            ReturnValue(0)
        }
        
        file_size = File_GetSize(fd)
        IfCondition LessEqual(file_size, 0) ThenBlock: {
            File_Close(fd)
            ReturnValue(0)
        }
        
        buffer = Allocate(Add(file_size, 1))
        bytes_read = File_Read(fd, buffer, file_size)
        File_Close(fd)
        
        IfCondition LessEqual(bytes_read, 0) ThenBlock: {
            Deallocate(buffer, Add(file_size, 1))
            ReturnValue(0)
        }
        
        SetByte(buffer, bytes_read, 0)
        ReturnValue(buffer)
    }
}

// =============================================================================
// IMPORT BLACKLIST CHECK
// =============================================================================
Function.Console_IsBlacklisted {
    Input: module_name: Address
    Output: Integer
    Body: {
        // Built-in types (already native)
        cmp = StringCompare(module_name, "dict")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [skip: 'dict' is built-in]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "list")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [skip: 'list' is built-in]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "str")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [skip: 'str' is built-in]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "int")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [skip: 'int' is built-in]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "float")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [skip: 'float' is built-in]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "bool")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [skip: 'bool' is built-in]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "tuple")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [skip: 'tuple' is built-in]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "typing")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [skip: 'typing' not needed]\n")
            ReturnValue(1)
        }
        
        // Unsupported Python stdlib
        cmp = StringCompare(module_name, "os")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [warn: 'os' not yet supported]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "sys")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [warn: 'sys' not yet supported]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "re")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [warn: 're' not yet supported]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "json")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [warn: 'json' not yet supported]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "math")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [warn: 'math' not yet supported]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "random")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [warn: 'random' not yet supported]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "time")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [warn: 'time' partially supported via Time.Unix]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "datetime")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [warn: 'datetime' not yet supported]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "collections")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [warn: 'collections' not yet supported]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "functools")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [warn: 'functools' not yet supported]\n")
            ReturnValue(1)
        }
        
        cmp = StringCompare(module_name, "itertools")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            PrintMessage("  [warn: 'itertools' not yet supported]\n")
            ReturnValue(1)
        }
        
        ReturnValue(0)
    }
}

// =============================================================================
// IMPORT EXTRACTION
// =============================================================================
Function.Console_ExtractWord {
    Input: source: Address
    Input: start: Integer
    Input: line_end: Integer
    Output: Address
    Body: {
        pos = start
        WhileLoop LessThan(pos, line_end) {
            c = GetByte(source, pos)
            IfCondition And(NotEqual(c, 32), NotEqual(c, 9)) ThenBlock: {
                BreakLoop
            }
            pos = Add(pos, 1)
        }
        
        word_start = pos
        WhileLoop LessThan(pos, line_end) {
            c = GetByte(source, pos)
            IfCondition Or(EqualTo(c, 32), EqualTo(c, 9)) ThenBlock: {
                BreakLoop
            }
            IfCondition Or(EqualTo(c, 44), EqualTo(c, 10)) ThenBlock: {
                BreakLoop
            }
            IfCondition EqualTo(c, 0) ThenBlock: {
                BreakLoop
            }
            pos = Add(pos, 1)
        }
        
        word_len = Subtract(pos, word_start)
        IfCondition LessEqual(word_len, 0) ThenBlock: {
            ReturnValue(0)
        }
        
        word = Allocate(Add(word_len, 1))
        i = 0
        WhileLoop LessThan(i, word_len) {
            c = GetByte(source, Add(word_start, i))
            SetByte(word, i, c)
            i = Add(i, 1)
        }
        SetByte(word, word_len, 0)
        
        ReturnValue(word)
    }
}

Function.Console_ExtractImports {
    Input: source: Address
    Output: Address
    Body: {
        imports = XArray.XCreate(16)
        
        pos = 0
        len = StringLength(source)
        line_start = 0
        
        WhileLoop LessThan(pos, len) {
            c = GetByte(source, pos)
            
            IfCondition EqualTo(c, 10) ThenBlock: {
                line_len = Subtract(pos, line_start)
                
                IfCondition GreaterEqual(line_len, 7) ThenBlock: {
                    c0 = GetByte(source, line_start)
                    c1 = GetByte(source, Add(line_start, 1))
                    
                    // Check for "import " (i=105)
                    IfCondition EqualTo(c0, 105) ThenBlock: {
                        c2 = GetByte(source, Add(line_start, 2))
                        c3 = GetByte(source, Add(line_start, 3))
                        c4 = GetByte(source, Add(line_start, 4))
                        c5 = GetByte(source, Add(line_start, 5))
                        c6 = GetByte(source, Add(line_start, 6))
                        
                        // "import " = 105 109 112 111 114 116 32
                        IfCondition EqualTo(c1, 109) ThenBlock: {
                            IfCondition EqualTo(c2, 112) ThenBlock: {
                                IfCondition EqualTo(c3, 111) ThenBlock: {
                                    IfCondition EqualTo(c4, 114) ThenBlock: {
                                        IfCondition EqualTo(c5, 116) ThenBlock: {
                                            IfCondition EqualTo(c6, 32) ThenBlock: {
                                                mod_start = Add(line_start, 7)
                                                mod_name = Console_ExtractWord(source, mod_start, pos)
                                                IfCondition NotEqual(mod_name, 0) ThenBlock: {
                                                    XArray.XPush(imports, mod_name)
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    // Check for "from " (f=102)
                    IfCondition EqualTo(c0, 102) ThenBlock: {
                        c2 = GetByte(source, Add(line_start, 2))
                        c3 = GetByte(source, Add(line_start, 3))
                        c4 = GetByte(source, Add(line_start, 4))
                        
                        // "from " = 102 114 111 109 32
                        IfCondition EqualTo(c1, 114) ThenBlock: {
                            IfCondition EqualTo(c2, 111) ThenBlock: {
                                IfCondition EqualTo(c3, 109) ThenBlock: {
                                    IfCondition EqualTo(c4, 32) ThenBlock: {
                                        mod_start = Add(line_start, 5)
                                        mod_name = Console_ExtractWord(source, mod_start, pos)
                                        IfCondition NotEqual(mod_name, 0) ThenBlock: {
                                            XArray.XPush(imports, mod_name)
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                
                line_start = Add(pos, 1)
            }
            
            pos = Add(pos, 1)
        }
        
        ReturnValue(imports)
    }
}

// =============================================================================
// PATH BUILDING
// =============================================================================
Function.Console_BuildAimPath {
    Input: module_name: Address
    Output: Address
    Body: {
        name_len = StringLength(module_name)
        path = Allocate(Add(name_len, 5))
        
        i = 0
        WhileLoop LessThan(i, name_len) {
            c = GetByte(module_name, i)
            SetByte(path, i, c)
            i = Add(i, 1)
        }
        
        SetByte(path, name_len, 46)
        SetByte(path, Add(name_len, 1), 97)
        SetByte(path, Add(name_len, 2), 105)
        SetByte(path, Add(name_len, 3), 109)
        SetByte(path, Add(name_len, 4), 0)
        
        ReturnValue(path)
    }
}

Function.Console_BuildOutputPath {
    Input: source_file: Address
    Input: output_dir: Address
    Output: Address
    Body: {
        src_len = StringLength(source_file)
        base_start = 0
        
        i = 0
        WhileLoop LessThan(i, src_len) {
            c = GetByte(source_file, i)
            IfCondition EqualTo(c, 47) ThenBlock: {
                base_start = Add(i, 1)
            }
            i = Add(i, 1)
        }
        
        ext_pos = src_len
        i = base_start
        WhileLoop LessThan(i, src_len) {
            c = GetByte(source_file, i)
            IfCondition EqualTo(c, 46) ThenBlock: {
                ext_pos = i
            }
            i = Add(i, 1)
        }
        
        base_len = Subtract(ext_pos, base_start)
        dir_len = StringLength(output_dir)
        
        total_len = Add(dir_len, Add(base_len, 9))
        path = Allocate(total_len)
        
        pos = 0
        i = 0
        WhileLoop LessThan(i, dir_len) {
            c = GetByte(output_dir, i)
            SetByte(path, pos, c)
            pos = Add(pos, 1)
            i = Add(i, 1)
        }
        
        SetByte(path, pos, 47)
        pos = Add(pos, 1)
        
        i = base_start
        WhileLoop LessThan(i, ext_pos) {
            c = GetByte(source_file, i)
            SetByte(path, pos, c)
            pos = Add(pos, 1)
            i = Add(i, 1)
        }
        
        // ".ailang"
        SetByte(path, pos, 46)
        pos = Add(pos, 1)
        SetByte(path, pos, 97)
        pos = Add(pos, 1)
        SetByte(path, pos, 105)
        pos = Add(pos, 1)
        SetByte(path, pos, 108)
        pos = Add(pos, 1)
        SetByte(path, pos, 97)
        pos = Add(pos, 1)
        SetByte(path, pos, 110)
        pos = Add(pos, 1)
        SetByte(path, pos, 103)
        pos = Add(pos, 1)
        SetByte(path, pos, 0)
        
        ReturnValue(path)
    }
}

// =============================================================================
// TRANSPILE SINGLE FILE (for project use)
// =============================================================================
Function.Console_CompileToOutput {
    Input: source: Address
    Input: source_file: Address
    Input: output_dir: Address
    Output: Address
    Body: {
        len = StringLength(source)
        
        Lex_Init(source, len)
        tok_count = Lex_Tokenize()
        
        IfCondition LessEqual(tok_count, 0) ThenBlock: {
            PrintMessage("  ERROR: Lexer failed\n")
            Lex_Free()
            ReturnValue(0)
        }
        
        Parse_Init()
        ast = Parse_Program()
        
        IfCondition EqualTo(Parse.err, 1) ThenBlock: {
            PrintMessage("  ERROR: Parse failed at line ")
            PrintNumber(Parse.err_line)
            PrintMessage("\n")
            Lex_Free()
            ReturnValue(0)
        }
        
        Gen_Init()
        Gen_Program(ast)
        output = Gen_GetOutput()
        
        out_file = Console_BuildOutputPath(source_file, output_dir)
        
        out_len = StringLength(output)
        
        // Write to file
        fd = File_Open(out_file, 577)
        IfCondition GreaterEqual(fd, 0) ThenBlock: {
            File_Write(fd, output, out_len)
            File_Close(fd)
        }
        
        PrintMessage("  -> ")
        PrintString(out_file)
        PrintMessage(" (")
        PrintNumber(out_len)
        PrintMessage(" bytes)\n")
        
        Deallocate(output, 0)
        Gen_Free()
        Lex_Free()
        
        ReturnValue(out_file)
    }
}

// =============================================================================
// MULTI-FILE PROJECT TRANSPILATION
// =============================================================================
Function.Console_TranspileProject {
    Input: main_file: Address
    Input: output_dir: Address
    Body: {
        PrintMessage("\n=== PROJECT TRANSPILATION ===\n")
        PrintMessage("Main file: ")
        PrintString(main_file)
        PrintMessage("\nOutput dir: ")
        PrintString(output_dir)
        PrintMessage("\n\n")
        
        to_process = XArray.XCreate(32)
        processed = XArray.XCreate(32)
        
        main_copy = Console_CopyString(main_file)
        XArray.XPush(to_process, main_copy)
        
        files_done = 0
        keep_looping = 1
        
        WhileLoop EqualTo(keep_looping, 1) {
            qs = XArray.XSize(to_process)
            IfCondition EqualTo(qs, 0) ThenBlock: {
                keep_looping = 0
            } ElseBlock: {
                current_file = XArray.XPop(to_process)
                
                already = Console_ArrayContains(processed, current_file)
                IfCondition EqualTo(already, 0) ThenBlock: {
                    PrintMessage("Transpiling: ")
                    PrintString(current_file)
                    PrintMessage("\n")
                    
                    source = Console_ReadFileContents(current_file)
                    IfCondition NotEqual(source, 0) ThenBlock: {
                        imports = Console_ExtractImports(source)
                        num_imports = XArray.XSize(imports)
                        
                        IfCondition GreaterThan(num_imports, 0) ThenBlock: {
                            PrintMessage("  Found ")
                            PrintNumber(num_imports)
                            PrintMessage(" import(s): ")
                            
                            i = 0
                            WhileLoop LessThan(i, num_imports) {
                                mod_name = XArray.XGet(imports, i)
                                PrintString(mod_name)
                                PrintMessage(" ")
                                
                                is_blocked = Console_IsBlacklisted(mod_name)
                                IfCondition EqualTo(is_blocked, 0) ThenBlock: {
                                    aim_path = Console_BuildAimPath(mod_name)
                                    exists = File_Exists(aim_path)
                                    
                                    IfCondition EqualTo(exists, 1) ThenBlock: {
                                        in_processed = Console_ArrayContains(processed, aim_path)
                                        IfCondition EqualTo(in_processed, 0) ThenBlock: {
                                            in_queue = Console_ArrayContains(to_process, aim_path)
                                            IfCondition EqualTo(in_queue, 0) ThenBlock: {
                                                XArray.XPush(to_process, aim_path)
                                            }
                                        }
                                    } ElseBlock: {
                                        PrintMessage("\n  [warn: ")
                                        PrintString(aim_path)
                                        PrintMessage(" not found]")
                                    }
                                }
                                
                                i = Add(i, 1)
                            }
                            PrintMessage("\n")
                        }
                        
                        Console_CompileToOutput(source, current_file, output_dir)
                        Deallocate(source, 0)
                    } ElseBlock: {
                        PrintMessage("  ERROR: Could not read file\n")
                    }
                    
                    XArray.XPush(processed, current_file)
                    files_done = Add(files_done, 1)
                }
            }
        }
        
        PrintMessage("\n=== TRANSPILATION COMPLETE ===\n")
        PrintMessage("Files processed: ")
        PrintNumber(files_done)
        PrintMessage("\nOutput directory: ")
        PrintString(output_dir)
        PrintMessage("\n\n")
        
        XArray.XDestroy(to_process)
        XArray.XDestroy(processed)
    }
}

// =============================================================================
// COMMAND PROCESSING
// =============================================================================
Function.Console_ProcessCommand {
    Input: cmd: Address
    Output: Integer
    Body: {
        trimmed = Console_Trim(cmd)
        trimmed_len = StringLength(trimmed)
        
        IfCondition EqualTo(trimmed_len, 0) ThenBlock: {
            Deallocate(trimmed, 0)
            ReturnValue(0)
        }
        
        cmp = StringCompare(trimmed, "quit")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            Console.running = 0
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        cmp = StringCompare(trimmed, "exit")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            Console.running = 0
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        cmp = StringCompare(trimmed, "help")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            Console_Help()
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        cmp = StringCompare(trimmed, "clear")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            Console.multiline_pos = 0
            PrintMessage("Buffer cleared.\n")
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        cmp = StringCompare(trimmed, "status")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            Console_Status()
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        cmp = StringCompare(trimmed, "example")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            Console_Example()
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        cmp = StringCompare(trimmed, "debug on")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            Console.debug_mode = 1
            Console.show_tokens = 1
            Console.show_ast = 1
            PrintMessage("Debug mode ON\n")
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        cmp = StringCompare(trimmed, "debug off")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            Console.debug_mode = 0
            Console.show_tokens = 0
            Console.show_ast = 0
            PrintMessage("Debug mode OFF\n")
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        cmp = StringCompare(trimmed, "tokens on")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            Console.show_tokens = 1
            PrintMessage("Token display ON\n")
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        cmp = StringCompare(trimmed, "tokens off")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            Console.show_tokens = 0
            PrintMessage("Token display OFF\n")
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        cmp = StringCompare(trimmed, "ast on")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            Console.show_ast = 1
            PrintMessage("AST display ON\n")
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        cmp = StringCompare(trimmed, "ast off")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            Console.show_ast = 0
            PrintMessage("AST display OFF\n")
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        starts_load = Console_StrStartsWith(trimmed, "load ")
        IfCondition EqualTo(starts_load, 1) ThenBlock: {
            filename = Console_GetArg(trimmed, 5)
            Console_LoadFile(filename)
            Deallocate(filename, 0)
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        starts_save = Console_StrStartsWith(trimmed, "save ")
        IfCondition EqualTo(starts_save, 1) ThenBlock: {
            filename = Console_GetArg(trimmed, 5)
            Console_SaveOutput(filename)
            Deallocate(filename, 0)
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        // === TRANSPILE COMMAND ===
        starts_transpile = Console_StrStartsWith(trimmed, "transpile ")
        IfCondition EqualTo(starts_transpile, 1) ThenBlock: {
            args = Console_GetArg(trimmed, 10)
            args_len = StringLength(args)
            
            // Find space separating file and dir
            space_pos = 0
            i = 0
            WhileLoop LessThan(i, args_len) {
                c = GetByte(args, i)
                IfCondition EqualTo(c, 32) ThenBlock: {
                    space_pos = i
                    BreakLoop
                }
                i = Add(i, 1)
            }
            
            IfCondition GreaterThan(space_pos, 0) ThenBlock: {
                // Extract filename
                main_file = Allocate(Add(space_pos, 1))
                i = 0
                WhileLoop LessThan(i, space_pos) {
                    c = GetByte(args, i)
                    SetByte(main_file, i, c)
                    i = Add(i, 1)
                }
                SetByte(main_file, space_pos, 0)
                
                // Extract output dir
                dir_start = Add(space_pos, 1)
                dir_len = Subtract(args_len, dir_start)
                output_dir = Allocate(Add(dir_len, 1))
                i = 0
                WhileLoop LessThan(i, dir_len) {
                    c = GetByte(args, Add(dir_start, i))
                    SetByte(output_dir, i, c)
                    i = Add(i, 1)
                }
                SetByte(output_dir, dir_len, 0)
                
                Console_TranspileProject(main_file, output_dir)
                
                Deallocate(main_file, 0)
                Deallocate(output_dir, 0)
            } ElseBlock: {
                PrintMessage("Usage: transpile <main.aim> <output_dir>\n")
            }
            
            Deallocate(args, 0)
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        Deallocate(trimmed, 0)
        ReturnValue(0)
    }
}

// =============================================================================
// MULTILINE INPUT HANDLING
// =============================================================================
Function.Console_AddToBuffer {
    Input: line: Address
    Body: {
        len = StringLength(line)
        
        i = 0
        WhileLoop LessThan(i, len) {
            c = GetByte(line, i)
            SetByte(Console.multiline_buf, Console.multiline_pos, c)
            Console.multiline_pos = Add(Console.multiline_pos, 1)
            i = Add(i, 1)
        }
        
        SetByte(Console.multiline_buf, Console.multiline_pos, 10)
        Console.multiline_pos = Add(Console.multiline_pos, 1)
        SetByte(Console.multiline_buf, Console.multiline_pos, 0)
    }
}

Function.Console_CheckEndMarker {
    Input: line: Address
    Output: Integer
    Body: {
        trimmed = Console_Trim(line)
        
        cmp = StringCompare(trimmed, "end")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        cmp = StringCompare(trimmed, "end;")
        IfCondition EqualTo(cmp, 0) ThenBlock: {
            Deallocate(trimmed, 0)
            ReturnValue(1)
        }
        
        Deallocate(trimmed, 0)
        ReturnValue(0)
    }
}

// =============================================================================
// MAIN ENTRY POINT
// =============================================================================
SubRoutine.Main {
    Console_Init()
    Console_Banner()
    
    in_multiline = 0
    
    WhileLoop EqualTo(Console.running, 1) {
        IfCondition EqualTo(in_multiline, 0) ThenBlock: {
            PrintMessage("aim> ")
        } ElseBlock: {
            PrintMessage("...> ")
        }
        
        line = ReadInput()
        
        IfCondition EqualTo(line, 0) ThenBlock: {
            Console.running = 0
            ContinueLoop
        }
        
        IfCondition EqualTo(in_multiline, 0) ThenBlock: {
            is_cmd = Console_ProcessCommand(line)
            IfCondition EqualTo(is_cmd, 1) ThenBlock: {
                ContinueLoop
            }
        }
        
        starts_def = Console_StrStartsWith(line, "def ")
        IfCondition EqualTo(starts_def, 1) ThenBlock: {
            Console.multiline_pos = 0
            in_multiline = 1
        }
        
        starts_class = Console_StrStartsWith(line, "class ")
        IfCondition EqualTo(starts_class, 1) ThenBlock: {
            Console.multiline_pos = 0
            in_multiline = 1
        }
        
        Console_AddToBuffer(line)
        
        is_end = Console_CheckEndMarker(line)
        IfCondition EqualTo(is_end, 1) ThenBlock: {
            IfCondition EqualTo(in_multiline, 1) ThenBlock: {
                Console_Compile(Console.multiline_buf)
                Console.multiline_pos = 0
                in_multiline = 0
            }
        }
    }
    
    PrintMessage("\nGoodbye!\n")
    Console_Free()
    ProcessExit(0)
}

RunTask(Main)